# frozen_string_literal: true
# typed: strict

require 'sorbet-runtime'
require 'yaml'
require 'test/unit'
require './lib/time_machine/validation/time_machine'


class TestValidation < Test::Unit::TestCase
  extend T::Sig

  sig {
    params(
      id: Integer,
      tags: T::Hash[String, String],
      geojson_geometry: String,
      is_change: T::Boolean,
      version: Integer,
      deleted: T::Boolean,
      group_ids: T.nilable(T::Array[String]),
      srid: Integer,
    ).returns(Validation::OSMChangeProperties)
  }
  def build_object(
    id:, tags:, geojson_geometry:, is_change:,
    version: 1, deleted: false, group_ids: nil,
    srid: 4326
  )
    Validation::OSMChangeProperties.new(
        objtype: 'n',
        id: id,
        geojson_geometry: geojson_geometry,
        geos_factory: OSMLogicalHistory.build_geos_factory(srid),
        geom_distance: 0,
        deleted: deleted,
        members: nil,
        version: version,
        changesets: nil,
        username: 'bob',
        created: 'today',
        tags: tags,
        is_change: is_change,
        group_ids: group_ids,
      )
  end

  CONFIG_YAML_HEADER = <<~YAML
    title:
      en: España Navarra
      es: España Navarra
    description:
      en: Spain Navarra.
      es: España Navarra.
    # Set your own OSM username, has admin right on all groups.
    main_contacts: [frodrigo]
    # Free keywords to describe the project
    project_tags: [highway]

    # Set a projection relative to the data location. Should be in meter unit.
    # If you don't know the projection, set the corresponding UTM Zone ESRID code from.
    local_srid: 32630

    # Distance between objects to be considered as a LoCha cluster.
    locha_cluster_distance: 100

    # Project title in different languages
    user_groups:
      # Track the OSM tags on an area
      navarra:
        title:
          es: Navarra
        # Use the boundary polygon defined by the corresponding OSM relation id
        polygon: ./navarra.geojson
        # Tags definition in the siblings export directory
        osm_tags: ./highway.osm_tags.json
        users: [] # OSM usernames, validation right on this group
  YAML

  sig { void }
  def test_time_machine_deleted
    accept_all_validators = [Validators::All.new(id: 'no_matching_user_groups', osm_tags_matches: Osm::TagsMatches.new([]), action: 'accept')]

    yaml = CONFIG_YAML_HEADER + <<~YAML
      validators:
        deleted:
          action_force: reject
    YAML
    config = Configuration.parse(YAML.unsafe_load(yaml), './test/fixtures/')

    assert_equal(1, config.user_groups.size)
    assert_not_empty(config.osm_tags_matches.match({ 'highway' => 'primary' }))
    assert_equal(1, config.user_groups.size)

    locha = [
      # deleted
      [1, '[
        {"geojson_geometry": "{\"type\": \"LineString\", \"coordinates\": [[-1.403669953346252, 43.33633041381836], [-1.403606057167053, 43.33631896972656]]}", "tags": {"highway": "primary"}, "created": "2024-04-21T17:40:33", "deleted": false, "members": null, "version": 8, "username": "Sint E7", "group_ids": ["navarra"], "is_change": false, "changesets": null},
        {"geojson_geometry": "{\"type\": \"LineString\", \"coordinates\": [[-1.403606057167053, 43.33631896972656], [-1.403542041778564, 43.336326599121094]]}", "tags": {"highway": "primary"}, "created": "2024-12-12T19:15:06", "deleted": true, "members": null, "version": 9, "username": "Sint E7", "group_ids": ["navarra"], "is_change": true, "changesets":
          [{"id": 160220548, "uid": 146393, "open": false, "user": "Sint E7", "maxlat": 43.495373, "maxlon": -1.0331469, "minlat": 43.071014, "minlon": -1.4963601, "closed_at": "2024-12-12T19:15:08", "created_at": "2024-12-12T19:15:06", "changes_count": 113, "comments_count": 0}]
        }
      ]'],
    ].collect{ |id, p|
      Validation.convert_locha_item({
        'objtype' => 'w',
        'id' => id,
        'p' => JSON.parse(p),
      }, config.local_srid)
    }

    r = Validation.time_machine_locha(config, 1, locha, accept_all_validators).semantic_clusters.collect(&:links).flatten(1)
    assert_equal(1, r.size)

    link = T.must(r[0])
    assert_equal(1, link.validations.size)
    assert_equal('reject', link.result.action)
    assert_equal('deleted', link.result.nil? ? nil : link.result.diff.attribs.dig('deleted', 0)&.validator_id)
  end

  sig { void }
  def test_time_machine_locha_propagate_rejection
    accept_all_validators = [Validators::All.new(id: 'no_matching_user_groups', osm_tags_matches: Osm::TagsMatches.new([]), action: 'accept')]

    yaml = CONFIG_YAML_HEADER + <<~YAML
      validators:
        deleted:
          action_force: reject
    YAML
    config = Configuration.parse(YAML.unsafe_load(yaml), './test/fixtures/')

    locha = [
      [1, [
        build_object(id: 1, geojson_geometry: '{"type":"LineString","coordinates":[[-1.60000, 43.0000],[-1.60000, 43.0001]]}', version: 1, tags: { 'highway' => 'primary', 'name' => 'a' }, is_change: false, group_ids: ['navarra']),
        build_object(id: 1, geojson_geometry: '{"type":"LineString","coordinates":[[-1.60000, 43.0000],[-1.60000, 43.0002]]}', version: 2, tags: { 'highway' => 'primary', 'name' => 'a' }, is_change: true, group_ids: ['navarra']),
      ]],
      [2, [
        build_object(id: 2, geojson_geometry: '{"type":"LineString","coordinates":[[-1.60000, 43.0000],[-1.60000, 43.0002]]}', version: 1, tags: { 'highway' => 'primary', 'name' => 'b' }, is_change: false, group_ids: ['navarra']),
        build_object(id: 2, geojson_geometry: '{"type":"LineString","coordinates":[[-1.60000, 43.0000],[-1.60000, 43.0002]]}', version: 2, tags: { 'highway' => 'primary', 'name' => 'b' }, is_change: true, deleted: true, group_ids: ['navarra'])
      ]],
    ].collect{ |id, p|
      Validation.convert_locha_item({
        'objtype' => 'w',
        'id' => id,
        'p' => JSON.parse(p.to_json),
      }, config.local_srid)
    }

    r = Validation.time_machine_locha(config, 1, locha, accept_all_validators).semantic_clusters.collect(&:links).flatten(1)
    assert_equal(3, r.size)
    assert_equal({ 'reject' => 3 }, r.group_by{ |link| link.result.action }.transform_values(&:size))
  end

  sig { void }
  def test_time_machine_relation_members
    accept_all_validators = [Validators::All.new(id: 'no_matching_user_groups', osm_tags_matches: Osm::TagsMatches.new([]), action: 'accept')]

    yaml = "#{CONFIG_YAML_HEADER}
validators: {}"
    config = Configuration.parse(YAML.unsafe_load(yaml), './test/fixtures/')

    locha = [
      # deleted
      [1, '[
        {"geojson_geometry": "{\"type\": \"LineString\", \"coordinates\": [[5.287988185882568, 45.018062591552734], [5.28761100769043, 45.01808166503906], [5.287246227264404, 45.01810073852539], [5.286636829376221, 45.01806640625], [5.286304950714111, 45.01805114746094], [5.285460948944092, 45.01801681518555], [5.285106182098389, 45.01799011230469], [5.284666061401367, 45.01789855957031], [5.284317970275879, 45.01771926879883], [5.28410005569458, 45.017616271972656], [5.283874988555908, 45.017581939697266], [5.283323764801025, 45.017601013183594], [5.283199787139893, 45.01763916015625], [5.2830810546875, 45.01777648925781], [5.282773017883301, 45.018009185791016], [5.282557010650635, 45.018165588378906], [5.282579898834228, 45.018184661865234], [5.282610893249512, 45.018211364746094], [5.282632827758789, 45.018253326416016], [5.282648086547852, 45.0182991027832], [5.282674789428711, 45.018497467041016], [5.282707214355469, 45.018592834472656], [5.282940864562988, 45.018856048583984], [5.283017158508301, 45.01893997192383], [5.283114910125732, 45.0191535949707], [5.283085823059082, 45.019378662109375], [5.282968997955322, 45.019691467285156], [5.282937049865723, 45.0197868347168], [5.282919883728027, 45.019832611083984], [5.282907009124756, 45.02048873901367], [5.282783031463623, 45.020992279052734], [5.283112049102783, 45.021575927734375], [5.283280849456787, 45.021766662597656], [5.283251762390137, 45.021968841552734], [5.283187866210938, 45.02199172973633], [5.283045768737793, 45.02204513549805], [5.282711982727051, 45.02216720581055], [5.282482147216797, 45.022254943847656], [5.282262802124023, 45.02233123779297], [5.282032012939453, 45.02244186401367], [5.281920909881592, 45.02238845825195], [5.281805038452148, 45.022377014160156], [5.281680107116699, 45.02238464355469], [5.281591892242432, 45.022396087646484], [5.281530857086182, 45.02240753173828], [5.281297206878662, 45.0224723815918], [5.281254768371582, 45.02248001098633], [5.281216144561768, 45.02247619628906], [5.281188011169434, 45.02246856689453], [5.281167030334473, 45.02245330810547], [5.281116008758545, 45.02239990234375], [5.280959129333496, 45.022247314453125], [5.280378818511963, 45.02176284790039], [5.280224800109863, 45.02164840698242], [5.280060768127441, 45.02153778076172], [5.280025005340576, 45.02151870727539], [5.279976844787598, 45.02150344848633], [5.279941082000732, 45.02149963378906], [5.279912948608398, 45.02151107788086], [5.279894828796387, 45.021522521972656], [5.27986478805542, 45.02156448364258], [5.279818058013916, 45.021644592285156], [5.27971887588501, 45.0218620300293], [5.279589176177978, 45.02208709716797], [5.279507160186768, 45.02223205566406], [5.279439926147461, 45.02237319946289], [5.279397010803223, 45.02244567871094], [5.27933406829834, 45.02251052856445], [5.279286861419678, 45.022560119628906], [5.279250144958496, 45.022586822509766], [5.279104232788086, 45.02267837524414], [5.278995990753174, 45.02275466918945], [5.278700828552246, 45.02296829223633], [5.278495788574219, 45.02311706542969], [5.278411865234375, 45.02318572998047], [5.278372764587402, 45.023258209228516], [5.278346061706543, 45.02332305908203], [5.27833080291748, 45.02339172363281], [5.278317928314209, 45.02348709106445], [5.278258800506592, 45.02366638183594], [5.278211116790772, 45.0237922668457], [5.278183937072754, 45.02388000488281], [5.278160095214844, 45.024009704589844], [5.278151035308838, 45.02410888671875], [5.278142929077148, 45.02419662475586], [5.278125762939453, 45.024261474609375], [5.278104782104492, 45.02431869506836], [5.278076171875, 45.02436828613281], [5.278028964996338, 45.02442932128906], [5.277973175048828, 45.02449417114258], [5.277937889099121, 45.0245475769043], [5.277891159057617, 45.02462387084961], [5.277851104736328, 45.02470016479492], [5.277820110321045, 45.02476119995117], [5.277791023254394, 45.02482986450195], [5.277763843536377, 45.02492904663086], [5.27771520614624, 45.025062561035156], [5.277655124664307, 45.02518081665039], [5.277510166168213, 45.02540969848633], [5.277443885803223, 45.02549362182617], [5.277390003204346, 45.025604248046875], [5.277362823486328, 45.02569580078125], [5.277341842651367, 45.025821685791016], [5.277321815490723, 45.025970458984375], [5.277303218841553, 45.02607345581055], [5.277278900146484, 45.02614974975586], [5.277256011962891, 45.02621078491211], [5.27723503112793, 45.026268005371094], [5.277217864990234, 45.02633285522461], [5.277208805084228, 45.026390075683594], [5.277194023132324, 45.026458740234375], [5.277163982391357, 45.026546478271484], [5.277130126953125, 45.02664566040039], [5.277106761932373, 45.0267219543457], [5.277077198028564, 45.02682113647461], [5.277052879333496, 45.0268669128418], [5.277007102966309, 45.02693176269531], [5.276924133300781, 45.027034759521484], [5.276882171630859, 45.027095794677734], [5.276857852935791, 45.02714538574219], [5.276835918426514, 45.027198791503906], [5.276819229125977, 45.02726364135742], [5.27678918838501, 45.0273323059082], [5.276753902435303, 45.02739715576172], [5.276691913604736, 45.027503967285156], [5.276616096496582, 45.0275764465332], [5.27653980255127, 45.02766036987305], [5.276459217071533, 45.02776336669922], [5.276406764984131, 45.0278434753418], [5.276368141174316, 45.02791213989258], [5.276287078857422, 45.02806854248047], [5.276237964630127, 45.02816390991211], [5.276167869567871, 45.02827072143555], [5.276110172271728, 45.028350830078125], [5.276049137115478, 45.02842712402344], [5.275968074798584, 45.028507232666016], [5.275889873504639, 45.02858352661133], [5.275813102722168, 45.02865219116211], [5.27576494216919, 45.02870559692383], [5.27573299407959, 45.02875900268555], [5.275710105895996, 45.0288200378418], [5.275691986083984, 45.02888870239258], [5.275691032409668, 45.02895736694336], [5.275701999664307, 45.02903747558594], [5.275732040405273, 45.029144287109375], [5.275766849517822, 45.02922821044922], [5.275814056396484, 45.029293060302734], [5.275864124298096, 45.02934265136719], [5.275959968566894, 45.029422760009766], [5.276000022888184, 45.029544830322266], [5.276011943817139, 45.029659271240234]]}", "tags": {"type": "route", "route": "hiking", "colour": "yellow", "highway": "primary", "osmc:symbol": "yellow:yellow:green_lower", "network:type": "node_network"}, "created": "2024-05-02T14:57:37", "deleted": false, "members": [{"ref": 807815881, "role": "", "type": "w"}, {"ref": 66360480, "role": "", "type": "w"}, {"ref": 66360477, "role": "", "type": "w"}, {"ref": 1279101903, "role": "", "type": "w"}, {"ref": 1279101901, "role": "", "type": "w"}, {"ref": 76961143, "role": "", "type": "w"}, {"ref": 1279061342, "role": "", "type": "w"}], "version": 1, "username": "pyrog", "group_ids": ["navarra"], "is_change": false, "changesets": null},
        {"geojson_geometry": "{\"type\": \"LineString\", \"coordinates\": [[5.276011943817139, 45.029659271240234], [5.276000022888184, 45.029544830322266], [5.275959968566894, 45.029422760009766], [5.275864124298096, 45.02934265136719], [5.275814056396484, 45.029293060302734], [5.275766849517822, 45.02922821044922], [5.275732040405273, 45.029144287109375], [5.275701999664307, 45.02903747558594], [5.275691032409668, 45.02895736694336], [5.275691986083984, 45.02888870239258], [5.275710105895996, 45.0288200378418], [5.27573299407959, 45.02875900268555], [5.27576494216919, 45.02870559692383], [5.275813102722168, 45.02865219116211], [5.275889873504639, 45.02858352661133], [5.275968074798584, 45.028507232666016], [5.276049137115478, 45.02842712402344], [5.276110172271728, 45.028350830078125], [5.276167869567871, 45.02827072143555], [5.276237964630127, 45.02816390991211], [5.276287078857422, 45.02806854248047], [5.276368141174316, 45.02791213989258], [5.276406764984131, 45.0278434753418], [5.276459217071533, 45.02776336669922], [5.27653980255127, 45.02766036987305], [5.276616096496582, 45.0275764465332], [5.276691913604736, 45.027503967285156], [5.276753902435303, 45.02739715576172], [5.27678918838501, 45.0273323059082], [5.276819229125977, 45.02726364135742], [5.276835918426514, 45.027198791503906], [5.276857852935791, 45.02714538574219], [5.276882171630859, 45.027095794677734], [5.276924133300781, 45.027034759521484], [5.277007102966309, 45.02693176269531], [5.277052879333496, 45.0268669128418], [5.277077198028564, 45.02682113647461], [5.277106761932373, 45.0267219543457], [5.277130126953125, 45.02664566040039], [5.277163982391357, 45.026546478271484], [5.277194023132324, 45.026458740234375], [5.277208805084228, 45.026390075683594], [5.277217864990234, 45.02633285522461], [5.27723503112793, 45.026268005371094], [5.277256011962891, 45.02621078491211], [5.277278900146484, 45.02614974975586], [5.277303218841553, 45.02607345581055], [5.277321815490723, 45.025970458984375], [5.277341842651367, 45.025821685791016], [5.277362823486328, 45.02569580078125], [5.277390003204346, 45.025604248046875], [5.277443885803223, 45.02549362182617], [5.277510166168213, 45.02540969848633], [5.277655124664307, 45.02518081665039], [5.27771520614624, 45.025062561035156], [5.277763843536377, 45.02492904663086], [5.277791023254394, 45.02482986450195], [5.277820110321045, 45.02476119995117], [5.277851104736328, 45.02470016479492], [5.277891159057617, 45.02462387084961], [5.277937889099121, 45.0245475769043], [5.277973175048828, 45.02449417114258], [5.278028964996338, 45.02442932128906], [5.278076171875, 45.02436828613281], [5.278104782104492, 45.02431869506836], [5.278125762939453, 45.024261474609375], [5.278142929077148, 45.02419662475586], [5.278151035308838, 45.02410888671875], [5.278160095214844, 45.024009704589844], [5.278183937072754, 45.02388000488281], [5.278211116790772, 45.0237922668457], [5.278258800506592, 45.02366638183594], [5.278317928314209, 45.02348709106445], [5.27833080291748, 45.02339172363281], [5.278346061706543, 45.02332305908203], [5.278372764587402, 45.023258209228516], [5.278411865234375, 45.02318572998047], [5.278495788574219, 45.02311706542969], [5.278700828552246, 45.02296829223633], [5.278995990753174, 45.02275466918945], [5.279104232788086, 45.02267837524414], [5.279250144958496, 45.022586822509766], [5.279286861419678, 45.022560119628906], [5.27933406829834, 45.02251052856445], [5.279397010803223, 45.02244567871094], [5.279439926147461, 45.02237319946289], [5.279507160186768, 45.02223205566406], [5.279589176177978, 45.02208709716797], [5.27971887588501, 45.0218620300293], [5.279818058013916, 45.021644592285156], [5.27986478805542, 45.02156448364258], [5.279894828796387, 45.021522521972656], [5.279912948608398, 45.02151107788086], [5.279941082000732, 45.02149963378906], [5.279976844787598, 45.02150344848633], [5.280025005340576, 45.02151870727539], [5.280060768127441, 45.02153778076172], [5.280224800109863, 45.02164840698242], [5.280378818511963, 45.02176284790039], [5.280959129333496, 45.022247314453125], [5.281116008758545, 45.02239990234375], [5.281167030334473, 45.02245330810547], [5.281188011169434, 45.02246856689453], [5.281216144561768, 45.02247619628906], [5.281254768371582, 45.02248001098633], [5.281297206878662, 45.0224723815918], [5.281530857086182, 45.02240753173828], [5.281591892242432, 45.022396087646484], [5.281680107116699, 45.02238464355469], [5.281805038452148, 45.022377014160156], [5.281920909881592, 45.02238845825195], [5.282032012939453, 45.02244186401367], [5.282262802124023, 45.02233123779297], [5.282482147216797, 45.022254943847656], [5.282711982727051, 45.02216720581055], [5.283045768737793, 45.02204513549805], [5.283187866210938, 45.02199172973633], [5.283251762390137, 45.021968841552734], [5.283280849456787, 45.021766662597656], [5.283112049102783, 45.021575927734375], [5.282783031463623, 45.020992279052734], [5.282907009124756, 45.02048873901367], [5.282919883728027, 45.019832611083984], [5.282937049865723, 45.0197868347168], [5.282968997955322, 45.019691467285156], [5.283085823059082, 45.019378662109375], [5.283114910125732, 45.0191535949707], [5.283017158508301, 45.01893997192383], [5.282940864562988, 45.018856048583984], [5.282707214355469, 45.018592834472656], [5.282674789428711, 45.018497467041016], [5.282648086547852, 45.0182991027832], [5.282632827758789, 45.018253326416016], [5.282610893249512, 45.018211364746094], [5.282579898834228, 45.018184661865234], [5.282557010650635, 45.018165588378906], [5.282773017883301, 45.018009185791016], [5.2830810546875, 45.01777648925781], [5.283199787139893, 45.01763916015625],[5.283323764801025, 45.017601013183594], [5.283874988555908, 45.017581939697266], [5.28410005569458, 45.017616271972656], [5.284317970275879, 45.01771926879883], [5.284666061401367, 45.01789855957031], [5.285106182098389, 45.01799011230469], [5.285460948944092, 45.01801681518555], [5.286304950714111, 45.01805114746094], [5.286636829376221, 45.01806640625], [5.287246227264404, 45.01810073852539], [5.28761100769043, 45.01808166503906], [5.287988185882568, 45.018062591552734]]}", "tags": {"type": "route", "route": "hiking", "colour": "yellow", "highway": "primary", "osmc:symbol": "yellow:yellow:green_lower", "network:type": "node_network"}, "created": "2024-12-11T08:28:54", "deleted": false, "members": [{"ref": 807815881, "role": "", "type": "w"}, {"ref": 66360480, "role": "", "type": "w"}, {"ref": 66360477, "role": "", "type": "w"}, {"ref": 1279101903, "role": "", "type": "w"}, {"ref": 1341742506, "role": "", "type": "w"}, {"ref": 1279101901, "role": "", "type": "w"}, {"ref": 76961143, "role": "", "type": "w"}, {"ref": 1279061342, "role": "", "type": "w"}], "version": 2, "username": "Virgile1994", "group_ids": ["navarra"], "is_change": true, "changesets": [{"id": 160158055, "uid": 362997, "open": false, "tags": {"source": "local knowlege", "comment": "Cohérence classification voirie Isère/Drôme", "created_by": "JOSM/1.5 (19160 fr)"}, "user": "Virgile1994", "maxlat": 45.523106, "maxlon": 5.365678, "minlat": 44.970573, "minlon": 4.87272, "closed_at": "2024-12-11T08:28:54", "created_at": "2024-12-11T08:28:47", "changes_count": 212, "comments_count": 0}]}
      ]'],
    ].collect{ |id, p|
      Validation.convert_locha_item({
        'objtype' => 'w',
        'id' => id,
        'p' => JSON.parse(p),
      }, config.local_srid)
    }

    r = Validation.time_machine_locha(config, 1, locha, accept_all_validators).semantic_clusters.collect(&:links).flatten(1)
    assert_equal(1, r.size)
    assert_equal('accept', r[0]&.result&.action)
  end
end
